<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Ensar Basri Kahveci">
        <link rel="canonical" href="https://microraft.io/blog/2023-04-05-queries/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>April 5, 2023 | Queries in MicroRaft - MicroRaft</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/docco.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-485423-8', 'auto');
            ga('send', 'pageview');
        </script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">MicroRaft</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Docs <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../docs/setup/" class="dropdown-item">Setup</a>
</li>
                                    
<li>
    <a href="../../docs/main-abstractions/" class="dropdown-item">Main Abstractions</a>
</li>
                                    
<li>
    <a href="../../docs/configuration/" class="dropdown-item">Configuration</a>
</li>
                                    
<li>
    <a href="../../docs/tutorial-building-an-atomic-register/" class="dropdown-item">Tutorial: Building an Atomic Register</a>
</li>
                                    
<li>
    <a href="../../docs/resiliency-and-fault-tolerance/" class="dropdown-item">Resiliency and Fault Tolerance</a>
</li>
                                    
<li>
    <a href="../../docs/monitoring/" class="dropdown-item">Monitoring</a>
</li>
                                    
<li>
    <a href="../../docs/afloatdb/" class="dropdown-item">AfloatDB - Distributed Key-Value Store</a>
</li>
                                    
<li>
    <a href="../../javadoc/0.8/index.html" class="dropdown-item">Javadoc 0.8</a>
</li>
                                    
<li>
    <a href="../../javadoc/0.7/index.html" class="dropdown-item">Javadoc 0.7</a>
</li>
                                    
<li>
    <a href="../../javadoc/0.6/index.html" class="dropdown-item">Javadoc 0.6</a>
</li>
                                    
<li>
    <a href="../../javadoc/0.5/index.html" class="dropdown-item">Javadoc 0.5</a>
</li>
                                    
<li>
    <a href="https://github.com/MicroRaft/MicroRaft/releases" class="dropdown-item">Release Notes</a>
</li>
                                    
<li>
    <a href="../../docs/roadmap/" class="dropdown-item">Roadmap</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Blog <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="./" class="dropdown-item active">April 5, 2023 | Queries in MicroRaft</a>
</li>
                                    
<li>
    <a href="../2023-02-15-log-replication/" class="dropdown-item">February 15, 2023 | Log replication in MicroRaft</a>
</li>
                                    
<li>
    <a href="../2022-11-12-implementing-the-log/" class="dropdown-item">November 12, 2022 | Implementing the log</a>
</li>
                                    
<li>
    <a href="../2021-09-08-today-a-raft-follower-tomorrow-a-raft-leader/" class="dropdown-item">September 8, 2021 | Today a Raft Follower, Tomorrow a Raft Leader</a>
</li>
                                    
<li>
    <a href="../2021-09-03-introducing-microraft/" class="dropdown-item">September 3, 2021 | Introducing MicroRaft</a>
</li>
                                    
<li>
    <a href=".." class="dropdown-item">All Blog Posts</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="https://github.com/MicroRaft/MicroRaft" class="nav-link">Github</a>
                            </li>
                            <li class="navitem">
                                <a href="https://twitter.com/MicroRaft" class="nav-link">Twitter</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../../docs/roadmap/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../2023-02-15-log-replication/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#queries-in-microraft" class="nav-link">Queries in MicroRaft</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#querypolicylinearizable" class="nav-link">QueryPolicy.LINEARIZABLE</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#querypolicyleader_lease" class="nav-link">QueryPolicy.LEADER_LEASE</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#querypolicyeventual_consistency" class="nav-link">QueryPolicy.EVENTUAL_CONSISTENCY</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#what-is-next" class="nav-link">What is next?</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="queries-in-microraft">Queries in MicroRaft</h1>
<p><em>April 5, 2023 | Ensar Basri Kahveci</em></p>
<p>This article is the fourth in <em>the ins and outs of MicroRaft</em> series. Here we
walk through the querying capabilities available in MicroRaft. You can see some
code samples <a href="https://microraft.io/docs/tutorial-building-an-atomic-register/#performing-queries" target="_blank">here</a>.</p>
<p>For impatient readers, TLDR is as follows:</p>
<ul>
<li>
<p>MicroRaft separates mutating and query operations via <a href="https://github.com/MicroRaft/MicroRaft/blob/031c049c2b8fc2cd2b356cbdee2091592c791651/microraft/src/main/java/io/microraft/RaftNode.java#L259" target="_blank"><code>RaftNode.replicate()</code></a>
  and <a href="https://github.com/MicroRaft/MicroRaft/blob/031c049c2b8fc2cd2b356cbdee2091592c791651/microraft/src/main/java/io/microraft/RaftNode.java#L364" target="_blank"><code>RaftNode.query()</code></a>
  APIs. These APIs return <a href="https://github.com/MicroRaft/MicroRaft/blob/master/microraft/src/main/java/io/microraft/Ordered.java" target="_blank"><code>Ordered</code></a>
  objects. <code>Ordered</code> wraps the actual result of an operation along with
  the commit index at which the operation is executed. MicroRaft offers
  3 policies to execute queries with different consistency and performance
  characteristics via <a href="https://github.com/MicroRaft/MicroRaft/blob/master/microraft/src/main/java/io/microraft/QueryPolicy.java" target="_blank"><code>QueryPolicy</code></a>:
  <code>QueryPolicy.LINEARIZABLE</code>, <code>QueryPolicy.LEADER_LEASE</code>, and
  <code>QueryPolicy.EVENTUAL_CONSISTENCY</code>.</p>
</li>
<li>
<p><code>QueryPolicy.LINEARIZABLE</code> achieves linearizable reads without growing to
  the internal Raft log. Before executing a query, the leader Raft node runs
  a round of <em>AppendEntries</em> RPC to ensure that it has not superseded by
  another Raft node. This approach prevents the log to grow because of queries
  and avoids fsync cost.</p>
</li>
<li>
<p><code>QueryPolicy.LEADER_LEASE</code> enables the leader to locally execute queries
  without communicating with the other Raft nodes. The leader maintains a lease
  on top of <a href="https://microraft.io/blog/2021-09-08-today-a-raft-follower-tomorrow-a-raft-leader/" target="_blank">the periodic heartbeating mechanism</a>.
  In short, as long as the clock skews, network delays and processing delays
  do not break the timing assumptions around the <em>leader heartbeat timeout</em>
  parameter, MicroRaft ensures that a new leader is not elected while
  the current leader is alive. Thus, the leader Raft node can achive
  linearizable reads without talking to the other nodes for queries.</p>
</li>
<li>
<p><code>QueryPolicy.EVENTUAL_CONSISTENCY</code> allows running a query operation locally
  on any Raft node. This policy helps clients to scale their query workload by
  distributing queries over multiple Raft nodes. In addition, clients can track
  commit indices they observe via <code>Ordered</code> objects, and pass them to
  <code>RaftNode.query()</code> calls to achieve <strong>monotonic reads</strong> and <strong>read your writes</strong>.</p>
</li>
</ul>
<p>Interested reads can keep reading to learn more details.</p>
<p>An operation passed to <code>RaftNode.replicate()</code> on the leader is committed and
executed once it is appended to the majority of the Raft group.
If the operation is read-only, i.e., it performs a <em>query</em> on the state machine
instead of mutating it, we still pay the cost of a disk write and fsync since
a new log entry is appended to the log. Moreover, if too many queries are
appended, MicroRaft can trigger the snapshotting mechanism to truncate the log
even if there is little change in the state machine. This is definitely
a sub-optimal situation.</p>
<p>Section 6.4 of the Raft dissertation discusses a number of techniques to bypass
the log and process queries with better performance. However, we should be
careful about the consistency of the state we observe via queries. Performance
and consistency is usually traded for each other, and Raft is no exception.</p>
<p>Here we explore how MicroRaft implements the techniques discussed in the Raft
dissertation. MicroRaft optimizes querying with 3 options, ranging from the one
with the smallest performance benefit and strongest consistency guarantee
to the one with the greatest performance benefit and weakest consistency
guarantee which allows achieving monotonic reads. For this, MicroRaft separates
queries from mutating operations with an API: <code>RaftNode.query()</code>. This API
expects a <code>QueryPolicy</code>, which is an enum with 3 possible values:
<code>QueryPolicy.LINEARIZABLE</code>, <code>QueryPolicy.LEADER_LEASE</code>, and
<code>QueryPolicy.EVENTUAL_CONSISTENCY</code>.</p>
<h2 id="querypolicylinearizable"><code>QueryPolicy.LINEARIZABLE</code></h2>
<p>We can use this policy achieve linearizability queries by bypassing the log.
When the leader Raft node receives a query, it saves the current commit index
and the query into an internal query state object. Then, it sends an
<a href="https://github.com/MicroRaft/MicroRaft/blob/031c049c2b8fc2cd2b356cbdee2091592c791651/microraft/src/main/java/io/microraft/model/message/AppendEntriesRequest.java" target="_blank"><code>AppendEntriesRequest</code></a>
to followers and waits for a majority acknowledgement. This request does not
contain the query itself and a small piece of information about waiting queries
are piggybacked into regular <code>AppendEntriesRequest</code> objects via
<a href="https://github.com/MicroRaft/MicroRaft/blob/031c049c2b8fc2cd2b356cbdee2091592c791651/microraft/src/main/java/io/microraft/model/message/AppendEntriesRequest.java#L55" target="_blank_"><code>AppendEntriesRequest.getQuerySequenceNumber()</code></a>.
<em>Query sequence number</em> works as a logic clock in each term and is incremented
every time a round of <em>AppendEntries</em> RPC is initiated for a query. Once
the majority Raft nodes acknowledge the current <em>query sequence number</em>,
the leader Raft node learns that there was no other leader at the moment
<code>AppendEntriesRequest</code>s were sent, hence executes the query on the state
machine and replies to the client.</p>
<p>MicroRaft amortizes the cost of leadership confirmation for multiple queries.
The leader accumulates all new queries received while there is an ongoing
<em>AppendEntries</em> RPC round for another query and executes all queries once
it receives a majority ack. To prevent OOMs on the leader RaftNode, MicroRaft
limits the number of pending queries by
<a href="https://github.com/MicroRaft/MicroRaft/blob/031c049c2b8fc2cd2b356cbdee2091592c791651/microraft/src/main/java/io/microraft/RaftConfig.java#L115" target="_blank"><code>RaftConfig.getMaxPendingLogEntryCount()</code></a>. 
If there is no available query slot, <code>RaftNode.query()</code> fails with
<a href="https://github.com/MicroRaft/MicroRaft/blob/master/microraft/src/main/java/io/microraft/exception/CannotReplicateException.java" target="_blank"><code>CannotReplicateException</code></a>,
so that clients can retry their queries later.</p>
<p>The leader Raft node must have committed a log entry on its term to make this
mechanism work. This is because the leader may not know the current commit index
after it is elected. It appends a custom entry to the log and replicates this
entry to discover the current commit index. In MicroRaft, this log entry
contains the operation provided by <a href="https://github.com/MicroRaft/MicroRaft/blob/031c049c2b8fc2cd2b356cbdee2091592c791651/microraft/src/main/java/io/microraft/statemachine/StateMachine.java#L149" target="_blank"><code>StateMachine.getNewTermOperation()</code></a>.
<code>RaftNode.query()</code> calls fail with <code>CannotReplicateException</code> when this
operation is not committed yet, so that clients can retry their queries later.</p>
<p>It can happen that the leader is partitioned away and the other Raft nodes have
already elected a new leader. In this case, the old leader cannot succeed
leadership confirmation for inflight queries. In MicroRaft, a leader
automatically steps down from leadership [TODO LINK HERE]
if the <em>leader heartbeat timeout</em> elapses before it receives
<em>AppendEntries RPC</em> responses from the half of the Raft group. It also fails
all pending queries with <a href="https://github.com/MicroRaft/MicroRaft/blob/master/microraft/src/main/java/io/microraft/exception/NotLeaderException.java" target="_blank"><code>NotLeaderException</code></a>
to enable clients retry their queries on other Raft nodes.</p>
<p>This overall mechanism is more efficient than appending queries to the log,
since it avoids disk writes and fsync for queries. However, the leader still
waits for a round of <em>AppendEntries</em> RPC to preserve linearizability.</p>
<h2 id="querypolicyleader_lease"><code>QueryPolicy.LEADER_LEASE</code></h2>
<p><code>QueryPolicy.LINEARIZABLE</code> achieves linearizability for queries by performing a
round of <em>AppendEntries</em> RPC among the majority. This approach is still safe
when clocks go rogue or messages get arbitrarily delayed (i.e., 
<strong>the asynchronous system model</strong>). MicroRaft offers another policy,
<code>QueryPolicy.LEADER_LOCAL</code>, to run queries in a linearizable manner without
communication between Raft nodes while a very strong timing assumption holds 
(i.e., <strong>the synchronous system model</strong>).</p>
<p>In MicroRaft, a follower does not vote for another Raft node if it has received
an <code>AppendEntriesRequest</code> in the last <em>leader heartbeat timeout</em> period. This
is called <em>leader stickiness</em>. Moreover, as we described above, a leader
automatically steps down from leadership if the <em>leader heartbeat timeout</em>
elapses before it receives <em>AppendEntries</em> RPC responses from the half of the
Raft group. These two techniques ensure that no new leader could be elected
while the current leader is alive, as long as clock drifts, network delays and
processing delays do not break the timing assumptions. Thus, the leader Raft
node can maintain a <a href="https://dl.acm.org/doi/10.1145/74851.74870"
target="_blank">lease</a> on top of the periodic heartbeating mechanism. It can
execute queries locally without communicating with the other Raft nodes and
still preserve linearizability for query results.</p>
<p>If the timing assumption around the <em>leader heartbeat timeout</em> is violated for
any reason, the leader could return stale results for locally executed queries.
Therefore, users of MicroRaft should carefully take operational challenges into
account while adjusting the <em>leader heartbeat timeout</em> parameter. If
linearizability is strictly required, it is better to use
<code>QueryPolicy.LINEARIZABLE</code> instead of <code>QueryPolicy.LEADER_LEASE</code>.</p>
<h2 id="querypolicyeventual_consistency"><code>QueryPolicy.EVENTUAL_CONSISTENCY</code></h2>
<p><code>QueryPolicy.LINEARIZABLE</code> and <code>QueryPolicy.LEADER_LEASE</code> require a query to be
executed by the leader Raft node. We can also execute queries on followers to
distribute the read workload via the last query policy option:
<code>QueryPolicy.EVENTUAL_CONSISTENCY</code>. Any Raft node can execute a query
with <code>QueryPolicy.EVENTUAL_CONSISTENCY</code> and return the result back to caller.
This policy does not guarantee to run queries on the most up to date state
machine, hence queries can return stale results. However, clients can still
preserve <strong>monotonic reads</strong> and <strong>read your writes</strong> guarantees for queries.</p>
<p>For monotonic reads, a simple solution is to make a client send its queries to
the same Raft node. This would be sufficient to preserve monotonicity for
the client as long as the Raft node is alive. However, if the Raft node fails,
the client can switch to another Raft node that is not as up-to-date as
the failed one, and its further queries return non-monotonic results. MicroRaft
offers a solution to prevent this problem. <code>RaftNode.replicate()</code> and
<code>RaftNode.query()</code> APIs return <code>Ordered</code> objects. <code>Ordered</code> wraps the actual
result of an operation along with the commit index at which the operation is
executed. Clients can track commit indices reported via <code>Ordered</code> objects
returned from queries and use them to ensure monotonic reads with this policy.
<code>RaftNode.query()</code> contains two optional parameters: <code>minCommitIndex</code> and
<code>timeout</code> for this. If the commit index of a Raft node becomes greater than or
equal to the requested <em>minimum commit index</em> for the given timeout duration,
the Raft node locally executes the query. Otherwise, it fails the query with
<code>LaggingCommitIndexException</code> so that the client can retry on another Raft
node. Clients can tune the timeout parameter to increase the likelihood of
a follower / learner Raft node to apply recently committed log entries.</p>
<p>Clients can achieve read your writes with a similar approach if they are also
doing mutations via <code>RaftNode.replicate()</code> in addition to queries. A client
can send its mutations to the leader Raft node, learn the commit index of its
mutation via the returned <code>Ordered</code> object, and pass this commit index to
queries it sends to the followers to ensure that it will read its own writes.</p>
<p><strong>Note:</strong> Before the version 0.6, MicroRaft also had
<code>QueryPolicy#BOUNDED_STALENESS</code> which was incorrectly named for the guarantees
it offered. This policy was deleted in <a href="https://github.com/MicroRaft/MicroRaft/commit/543fc2022072381de448218da243f9254f635720" target="_blank">this commit</a>.</p>
<h2 id="what-is-next">What is next?</h2>
<p>In the next post, we will explore how MicroRaft implements membership changes.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>MicroRaft, 2021. Open-sourced by <a href="https://twitter.com/metanet" target="_blank">Ensar Basri Kahveci</a>.<br/>MicroRaft is not affiliated, associated, endorsed by, or in any way officially connected with<br/>Facebook, or any of its subsidiaries or its affiliates.</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
